import asyncio
import json
import os
import uuid
from datetime import datetime

import streamlit as st
from openai import OpenAI
from utils.data_io import append_record

# ---- Agent ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆç¤¾å†… / å¤–éƒ¨ï¼‰------------
from agents import Agent, Runner, SQLiteSession

st.set_page_config(page_title="ğŸ“ ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ", page_icon="ğŸ“")

# ------------ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ --------------
DEFAULT_AGENT_PROMPT = """
ã‚ãªãŸã¯ã€ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‹ã‚‰ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åº¦åˆã„ã‚’åˆ†æã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚å…¥åŠ›ã•ã‚ŒãŸãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’åŸºã«ã€ä»¥ä¸‹ã®å½¢å¼ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ


* **ãƒ¬ãƒãƒ¼ãƒˆå:** ï¼ˆãƒ¬ãƒãƒ¼ãƒˆã®åå‰ï¼‰
* **ãƒ¬ãƒãƒ¼ãƒˆç¨®é¡:** ï¼ˆã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ã€æ—¥æ¬¡ã€æœˆæ¬¡ã€é€±æ¬¡ãªã©ï¼‰
* **ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ:** ï¼ˆãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå› ã‚„çŠ¶æ³ã‚’ç°¡æ½”ã«è¨˜è¿°ï¼‰
* **ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡:** ã€‡ã€‡%ï¼ˆç¯„å›²ã§ã¯ãªãã€å˜ä¸€ã®æ•°å€¤ã®ã¿ã‚’è¿”ã™ï¼‰

***

### ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡ã®åˆ¤æ–­åŸºæº–

ãƒãƒ£ãƒƒãƒˆå†…ã®ã‚„ã‚Šå–ã‚Šã«åŸºã¥ãã€ä»¥ä¸‹ã®åŸºæº–ã¨äº‹ä¾‹ã‚’å‚è€ƒã«ã—ã¦ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

#### **ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡: 0-20% ï¼ˆğŸŸ¢ ã‚¹ãƒ ãƒ¼ã‚ºãªçŠ¶æ…‹ï¼‰**

**ç‰¹å¾´:** å®šå‹çš„ãªå ±å‘Šã‚„ç¢ºèªãŒä¸­å¿ƒã€‚è»½å¾®ãªä¿®æ­£ä¾é ¼ã¯ã‚ã‚‹ã‚‚ã®ã®ã€ã‚„ã‚Šå–ã‚Šã¯å††æ»‘ã§ã€æ„Ÿè¬ã‚„è‚¯å®šçš„ãªè¨€è‘‰ã§ç· ã‚ããã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã€‚

* **å®šå‹å ±å‘Šã¨ç¢ºèª:**
    * `ã€Œæœ¬æ—¥åˆ†ã®æ›´æ–°å®Œäº†ã—ã¾ã—ãŸã®ã§ã”å ±å‘Šã„ãŸã—ã¾ã™ã€‚ã€`
    * `ã€Œå†…å®¹å•é¡Œã”ã–ã„ã¾ã›ã‚“ã§ã—ãŸï¼ã€`
    * `ã€Œã”ç¢ºèªã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚èªè­˜ç›¸é•ã”ã–ã„ã¾ã›ã‚“ï¼ã€`
* **è»½å¾®ãªä¿®æ­£ã¨è¿…é€Ÿãªè§£æ±º:**
    * `ã€Œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‹ã£ãŸã¾ã¾ã¨ãªã£ã¦ã„ã‚‹ç®‡æ‰€ãŒã”ã–ã„ã¾ã—ãŸã®ã§ã€ãã“ã ã‘ä¿®æ­£ã—ã¦ç´å“ã¾ã§ã”å¯¾å¿œãŠé¡˜ã„è‡´ã—ã¾ã™ã€` â†’ `ã€Œã”ç¢ºèªã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä¿®æ­£ã—ã¦ç´å“è‡´ã—ã¾ã—ãŸã€‚ã€`
    * `ã€Œæœ¬ä»¶ã€ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯åŠ›çŸ³ãƒ»èŠ±ç”°å®›ã¦ã«ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€` â†’ `ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚æœ¬ä»¶ã®å ±å‘Šéš›ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦æ‰¿çŸ¥è‡´ã—ã¾ã—ãŸã€‚ã€`

***

#### **ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡: 21-40% ï¼ˆğŸŸ¡ è»½å¾®ãªå•é¡Œãƒ»éåŠ¹ç‡ã®ç™ºç”Ÿï¼‰**

**ç‰¹å¾´:** ãƒ—ãƒ­ã‚»ã‚¹ä¸Šã®è»½å¾®ãªãƒŸã‚¹ã‚„ç¢ºèªä¸è¶³ãŒç™ºç”Ÿã€‚è¬ç½ªã‚„å†ç¢ºèªãŒå¢—ãˆå§‹ã‚ã‚‹ãŒã€ã‚„ã‚Šå–ã‚Šè‡ªä½“ã¯å”åŠ›çš„ã€‚

* **ãƒ—ãƒ­ã‚»ã‚¹ä¸Šã®ãƒŸã‚¹ã‚„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:**
    * `ã€Œæ˜¨æ—¥ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹æ”¹ã‚ã¦ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã®ä¸‹9æ¡æ•°å­—ãŒ0ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹...ã€`
    * `ã€Œå®Ÿã¯æ˜¨æ—¥...ä¸Šè¨˜æ¡ˆä»¶ç®¡ç†è¡¨ã¸ç·¨é›†ãŒã‹ã‘ã‚‰ã‚Œã¦ã—ã¾ã£ã¦ã„ãŸã‚ˆã†ã§ã—ã¦ã€å¾©å…ƒä½œæ¥­ãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã—ãŸ...ã€`
* **ä¸æ˜ç‚¹ã®ç¢ºèªã‚„èªè­˜ã®ã‚ºãƒ¬:**
    * `ã€Œã„ãŸã ã„ãŸå†…å®¹ãŒã‚ã¾ã‚Šç†è§£ã§ãã¦ã„ãªã„ã‚“ã ã‘ã©è¿”ã›ã‚‹ã‹ã—ã‚‰ï¼Ÿã€`
    * `ã€Œ...æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¿½åŠ ã•ã‚ŒãŸã§ã™ãŒã€ã“ã¡ã‚‰ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ã€`
* **è¬ç½ªã‚’ä¼´ã†ã‚„ã‚Šå–ã‚Š:**
    * `ã€Œã”è¿”äº‹é…ããªã‚Šç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã€`
    * `ã€Œã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¦ã—ã¾ã„å¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ä»Šå¾Œ...æ§ãˆã‚‹ã‚ˆã†å¾¹åº•ã„ãŸã—ã¾ã™ã€‚ã€`

***

#### **ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡: 41-60% ï¼ˆğŸŸ  æ˜ç¢ºãªå•é¡Œãƒ»æ‰‹æˆ»ã‚Šï¼‰**

**ç‰¹å¾´:** æ˜ã‚‰ã‹ãªä½œæ¥­æ¼ã‚Œã‚„ãƒŸã‚¹ãŒç™ºç”Ÿã—ã€å…·ä½“çš„ãªä¿®æ­£æŒ‡ç¤ºã‚„æ‰‹æˆ»ã‚ŠãŒå¿…è¦ã«ãªã‚‹ã€‚ç´æœŸã®å»¶é•·ä¾é ¼ã‚„ã€æŒ‡ç¤ºå†…å®¹ã®ç†è§£ä¸è¶³ãŒè¦‹ã‚‰ã‚Œã‚‹ã€‚

* **ä½œæ¥­æ¼ã‚Œã‚„ãƒŸã‚¹ã«å¯¾ã™ã‚‹æŒ‡æ‘˜:**
    * `ã€Œ1556è¡Œç›®ã®PLAY!PLAY!PLAY!ã‚‚ã”å¯¾å¿œã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚ã€`
    * `ã€Œã€OCEANã€ã®æƒ³å®šéƒ¨åˆ†ãªã®ã§ã™ãŒã€äºˆç®—ï¼ˆã‚³ã‚¹ãƒˆï¼‰ã ã‘ä¸‹è¨˜ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ©ãƒ³ã¨ç›¸é•ã—ã¦ãŠã‚Šâ€¦æ¬¡å›ã”ä½œæˆæ™‚ã«ã”ç•™æ„ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ï¼Ÿã€`
* **æŒ‡ç¤ºå†…å®¹ã®ç†è§£ä¸è¶³ã¨è³ªå•:**
    * `ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€è²»ç”¨æ¯”ç‡1:1ã§æŒ‰åˆ†ã™ã‚‹æ–¹æ³•ã‚’å­˜ã˜ã¦ãŠã‚Šã¾ã›ã‚“ã€‚ãã®ãŸã‚æŒ‰åˆ†æ–¹æ³•ã‚’æ•™ãˆã¦ã„ãŸã ãã¾ã™ã¨å¹¸ã„ã§ã™ã€‚ã€`
    * `ã€Œã™ã¿ã¾ã›ã‚“ã€ã„ãŸã ã„ã¦ã„ã‚‹è³ªå•ãŒã‚ˆãã‚ã‹ã‚‰ãšã€ã©ã“ã‚’ç¢ºèªã™ã‚Œã°ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿã€`
* **ç´æœŸã®å»¶é•·ä¾é ¼:**
    * `ã€Œæœ¬ä»¶ã®ãƒ¬ãƒãƒ¼ãƒˆã®ç´æœŸ2æ™‚é–“ãã‚‰ã„å»¶é•·ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ã€‚ã€`

***

#### **ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡: 61-80% ï¼ˆğŸ”´ é‡å¤§ãªå•é¡Œãƒ»é »ç™ºã™ã‚‹æ‰‹æˆ»ã‚Šï¼‰**

**ç‰¹å¾´:** æå‡ºç‰©ã®å“è³ªã«é‡å¤§ãªå•é¡ŒãŒã‚ã‚Šã€ä½•åº¦ã‚‚ä¿®æ­£ã®ã‚„ã‚Šå–ã‚ŠãŒç™ºç”Ÿã€‚æŒ‡ç¤ºãŒè¤‡é›‘åŒ–ã—ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ã‚¹ãƒˆãŒè‘—ã—ãå¢—å¤§ã—ã¦ã„ã‚‹ã€‚

* **é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã¨ç·Šæ€¥ã®ä¿®æ­£ä¾é ¼:**
    * `ã€Œæœ¬ä»¶ãƒ¬ãƒãƒ¼ãƒˆé›†è¨ˆã¨ç®¡ç†ç”»é¢æ•°å€¤ãŒã‚ã£ã¦ãŠã‚‰ãšã€ç¢ºèªã—ãŸã¨ã“ã‚ã€é›†è¨ˆCPã«5æœˆåˆ†å«ã‚æ¼ã‚ŒãŒç™ºç”Ÿã—ã¦ãŠã‚Šã¾ã—ãŸ...æ—©æ€¥ã«...ä½œæˆã‚’ãŠé¡˜ã„ã§ãã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚ã€`
    * `ã€Œã“ã¡ã‚‰ã®ä»¶ã§ã™ãŒæ•°å€¤ã®åæ˜ ãŒå£Šã‚Œã¦ã„ã¾ã™ã—ã€ã©ã¡ã‚‰ã‚‚6æœˆã®æ•°å€¤ã®ã¿ãŒæ ¼ç´ã•ã‚Œã¦ãŠã‚ŠExcelãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã§ã™ã€‚æœ¬ä»¶æ—©ã€…ã«ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ã€`
* **ä½•åº¦ã‚‚ç¶šãä¿®æ­£ã¨ç¢ºèªã®ãƒ«ãƒ¼ãƒ—:**
    * `ã€Œã“ã¡ã‚‰ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã©ã“ã‚’ä¿®æ­£ã—ãŸã®ã‹æ•™ãˆã¦é ‚ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ï¼ŸCPVãŒå«ã¾ã‚Œã¦ãŠã‚‰ãšé‡‘é¡ã‚‚å¤‰ã‚ã£ã¦ã„ãªã„ã§ã™ï¼ã€`
    * `ã€Œè¦ã™ã‚‹ã«ã€â‘ 5æœˆã¯èª¤ã£ãŸãƒ¬ãƒãƒ¼ãƒˆæ•°å€¤ã‚’ä½¿ç”¨ï¼‹â‘¡6ãƒ»7æœˆã¯é€šå¸¸ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã€5ï¼7æœˆã®é€šæœŸãƒ¬ãƒãƒ¼ãƒˆ(PPT)ã‚’ä½œæˆé ‚ããŸã„ã¨ã„ã†ã®ãŒä»Šå›ã®ä¾é ¼ã«ãªã‚Šã¾ã™ã€‚ã€`
* **è¤‡é›‘ãªãƒ«ãƒ¼ãƒ«å¤‰æ›´ã¨åº¦é‡ãªã‚‹è³ªç–‘:**
    * ãƒ•ãƒ­ãƒ¼å¤‰æ›´ã®ææ¡ˆã‹ã‚‰å§‹ã¾ã‚Šã€MTGè¨­å®šã€å‚åŠ è€…èª¿æ•´ã€èªè­˜åˆã‚ã›ã®è³ªç–‘å¿œç­”ãŒé•·æœŸé–“ã«ã‚ãŸã£ã¦ç¶šã„ã¦ã„ã‚‹çŠ¶æ…‹ã€‚

***

#### **ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡: 81-100% ï¼ˆğŸš¨ å±æ©Ÿçš„çŠ¶æ³ãƒ»èµ¤å­—ä½œæ¥­ï¼‰**

**ç‰¹å¾´:** **å®Œå…¨ã«èµ¤å­—çš„ãªä½œæ¥­çŠ¶æ…‹ã€‚** ç´æœŸé…å»¶ãŒå¸¸æ…‹åŒ–ã—ã€åŒã˜ãƒŸã‚¹ãŒç¹°ã‚Šè¿”ã—ç™ºç”Ÿã€‚ä½œæ¥­å“è³ªãŒè‘—ã—ãä½ãã€èƒ½åŠ›ãã®ã‚‚ã®ã‚’å•ã‚ã‚Œã‚‹ã‚ˆã†ãªå³ã—ã„æŒ‡æ‘˜ãŒå…¥ã‚‹ã€‚ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç ´ç¶»å¯¸å‰ã€‚

* **æ·±åˆ»ãªç´æœŸé…å»¶ã¨å‚¬ä¿ƒ:**
    * `ã€Œæœ¬ä»¶ã«ã¤ãã¾ã—ã¦æ˜¨æ—¥ãŒç´æœŸã ã£ãŸã‚“ã§ã™ãŒã€é€²æ—ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿã¾ã ã€ç´å“ã•ã‚Œã¦ã„ãªã„ã¿ãŸã„ãªã®ã§å¯èƒ½ã§ã‚ã‚Œã°ç´æœŸéãã¦ã„ã‚‹ã®ã§ãŠæ—©ã‚ã«ä½œæˆã—ã¦ç´å“ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚ã€`
* **ç¹°ã‚Šè¿”ã•ã‚Œã‚‹åŒã˜ãƒŸã‚¹ã¸ã®å³ã—ã„æŒ‡æ‘˜:**
    * `ã€ŒCriteoã®æ•°å€¤ãŒå‰å›åŒæ§˜ã“ã¡ã‚‰ã¨é•ã†ã¿ãŸã„ã§ã™ã€‚ã€‚ã€‚ã€`â†’`ã€Œã‚„ã£ã±ã‚ŠCriteoã®æ•°å€¤ãŒé•ã†ã¿ãŸã„ã§ã—ã¦...ã€`
    * `ã€Œæœ¬ä»¶ã‚³ã‚¹ãƒˆã‚’è»¢è¨˜ã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã™ãŒã€ä¸¦èµ°æœŸé–“ã»ã¨ã‚“ã©ãƒŸã‚¹ãŒç™ºç”Ÿã—ã¦ãŠã‚Šã¾ã™ã€‚ä½•æ•…ã§ã—ã‚‡ã†ã‹ï¼Ÿæ˜æ—¥ã¯æ›´ã«æ³¨æ„ã—ã¦ã”å¯¾å¿œãŠé¡˜ã„è‡´ã—ã¾ã™ã€‚ã€`
* **ãƒã‚¤ã‚¯ãƒ­ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆçŠ¶æ…‹ã®ä¿®æ­£ä¾é ¼:**
    * `ã€ŒGoogleãƒ»Yahoo!å„5ä»¶ãšã¤ã€æœ€å¤§10å€‹ã®è¨˜è¼‰ã¨ã—ã¦é ‚ããŸã„ã§ã™ã€‚ã€`
    * `ã€Œç¾çŠ¶ã‚­ãƒ£ãƒ—ãƒãƒ£ã®ç”»è³ªãŒè’ãç«¶åˆåã®ç¢ºèªãŒé›£ã—ã„ãŸã‚ã€æ¬¡å›ã‹ã‚‰...å¤§ããå–å¾—ã„ãŸã ãã“ã¨ã¯å¯èƒ½ã§ã—ã‚‡ã†ã‹ï¼Ÿã€`
    * 1ã¤ã®ã‚¿ã‚¹ã‚¯ã«å¯¾ã—ã¦10å›ä»¥ä¸Šã®å…·ä½“çš„ãªä¿®æ­£æŒ‡ç¤ºã¨ç¢ºèªã®å¾€å¾©ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã€‚
"""

DEFAULT_JSON_PROMPT = """å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¬¡ã® 4 é …ç›®ã‚’ JSON ã§æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
- ãƒ¬ãƒãƒ¼ãƒˆå
- ãƒ¬ãƒãƒ¼ãƒˆç¨®é¡
- ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ(æ–‡å­—åˆ—)
- ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡(ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®æ•°å€¤)
æ¨è«–éç¨‹ã¯å«ã‚ãšã€JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
"""

# ------------ OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ --------------
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])


async def run_agent(conversation: str, prompt: str) -> str:
    agent = Agent(name="Frustration Report Agent", instructions=prompt, model = "o3")
    session = SQLiteSession(f"session_{uuid.uuid4()}")
    result = await Runner.run(agent, conversation, session=session)
    return result.final_output


def extract_json(report: str, json_prompt: str) -> dict:
    messages = [
        {"role": "system", "content": json_prompt},
        {"role": "user", "content": report},
    ]
    resp = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=messages,
        response_format={"type": "json_object"},
        temperature=0,
    )
    return json.loads(resp.choices[0].message.content)


# ================= Streamlit UI =================
st.header("ğŸ“ ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ")

with st.expander("ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†ã™ã‚‹", expanded=False):
    agent_prompt = st.text_area("Agent Prompt", value=DEFAULT_AGENT_PROMPT, height=180)

with st.expander("JSON æŠ½å‡ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†ã™ã‚‹", expanded=False):
    json_prompt = st.text_area("JSON Prompt", value=DEFAULT_JSON_PROMPT, height=120)

conversation = st.text_area("å¯¾è©±å±¥æ­´ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„", height=280)

if st.button("ğŸš€ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ", disabled=not conversation.strip()):
    with st.spinner("LLM ç”Ÿæˆä¸­..."):
        report = asyncio.run(run_agent(conversation, agent_prompt))
        extracted = extract_json(report, json_prompt)
        extracted["timestamp"] = datetime.utcnow().isoformat()
        append_record(extracted)

    st.success("âœ… ç”Ÿæˆï¼†ä¿å­˜ã—ã¾ã—ãŸ")
    st.subheader("å‡ºåŠ›ãƒ¬ãƒãƒ¼ãƒˆ")
    st.code(report, language="markdown")
    st.subheader("ä¿å­˜ã•ã‚ŒãŸ JSON")
    st.json(extracted, expanded=False)